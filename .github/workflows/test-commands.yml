name: Test Slash Commands

on:
  push:
    paths:
      - '.claude/commands/**'
      - '.claude/agents/**'
      - 'tests/commands/**'
  pull_request:
    paths:
      - '.claude/commands/**'
      - '.claude/agents/**'
      - 'tests/commands/**'

jobs:
  validate-syntax:
    name: Static Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate command syntax
        run: |
          chmod +x tests/commands/test_command_syntax.sh
          ./tests/commands/test_command_syntax.sh

  test-inline-bash:
    name: Inline Bash Pattern Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml

      - name: Test inline bash patterns
        run: pytest tests/commands/test_inline_bash.py -v

  validate-agents:
    name: Agent Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate agent files exist
        run: |
          echo "Checking agent files..."
          for agent in .claude/agents/*.md; do
            if [ -f "$agent" ]; then
              echo "✓ Found: $agent"
            fi
          done
          echo "Agent validation complete."

      - name: Check agent references in commands
        run: |
          echo "Checking agent references..."
          # Extract agent names from commands and verify they exist
          for cmd in .claude/commands/*.md; do
            # Find referenced agents (pattern: **agent-name** agent)
            agents=$(grep -oE '\*\*[a-z-]+\*\* agent' "$cmd" 2>/dev/null | sed 's/\*\*//g' | sed 's/ agent//' || true)
            for agent in $agents; do
              if [ -f ".claude/agents/${agent}.md" ]; then
                echo "✓ $cmd references $agent (exists)"
              else
                echo "⚠ $cmd references $agent (not found - may be built-in)"
              fi
            done
          done
